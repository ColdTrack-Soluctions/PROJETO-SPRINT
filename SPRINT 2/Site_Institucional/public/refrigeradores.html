<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel - Dashboard</title>
  <link REL="SHORTCUT ICON" HREF="../assets/imagens/Logo_Quadrada-removebg.png">
  <link rel="stylesheet" href="css/refrigeradores.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div class="header">
    <div class="container_header">
      <div class="imagem1">
        <img src="../assets/imagens/logo.svg" alt="" class="imagemfixa">
      </div>
      <div class="opcPrincipais">
        <a href="orcamento-cadastrado.html">Orçamentos</a>
        <a href="calculadora-cadastrado.html">Calculadora</a>
      </div>
      <a href="decisao-dashbord.html">Voltar</a>
    </div>

  </div>

  <div class="container">
    <h1 style="margin-bottom: -3px;" id="titulo_refrigerador">  </h1>

    <div class="container-chart" id="containerchart">
      <div class="dash">
        <div id="alerta">
        </div>

        <div class="btns-dash" id="btnRefrigerador">
            <!-- O gráfico é chamado de acordo com o id (fk_aquario) do banco  -->
        </div>
        <div id="graficos">
        </div>
    </div>
    
  </div>
</body>
<script>
window.onload = () => {
exibirRefrigeradoresDoUsuario();
}



function exibirRefrigeradoresDoUsuario() {
        var refrigeradores = JSON.parse(sessionStorage.getItem('Refrigeradores'));
        // console.log(refrigeradores);
        refrigeradores.forEach(item => {
          console.log(item);


            document.getElementById("btnRefrigerador").innerHTML += `
            <button class="btn-chart" onclick="exibirRefrigerador(${item.Refrigerador_id})" id="btnRefrigerador${item.Refrigerador_id}">${item.Local}</button>
            `
            document.getElementById("graficos").innerHTML += `
                <div id="grafico${item.Refrigerador_id}" class="display-none">
                    <h3 class="tituloGraficos">
                        <span id="tituloRefrigerador${item.Refrigerador_id}">${item.Local}</span>
                    </h3>
                    <div class="graph">
                        <canvas id="myChartCanvas${item.Refrigerador_id}"></canvas>
                    </div>
                    <div class="label-captura">
                        <p id="avisoCaptura${item.Refrigerador_id}" style="color: white"></p>
                    </div>
                </div>
            `

            
            obterDadosGrafico(item.Refrigerador_id)
        });

        if (refrigeradores.length > 0) {
            // exibirAquario(aquarios[0].id)
        }
    }


    function obterDadosGrafico(idRefrigerador) {

    // alterarTitulo(idAquario)

// if (proximaAtualizacao != undefined) {
    // clearTimeout(proximaAtualizacao);
// }

fetch(`/medidas/ultimas/${idRefrigerador}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
        response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            resposta.reverse();

            plotarGrafico(resposta, idRefrigerador);

        });
    } else {
        console.error('Nenhum dado encontrado ou erro na API');
    }
})
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });
}

    function exibirRefrigerador(idRefrigerador) {
        let todosOsGraficos = JSON.parse(sessionStorage.getItem('Refrigeradores'));

        for (i = 0; i < todosOsGraficos.length; i++) {
            // exibindo - ou não - o gráfico
            if (todosOsGraficos[i].Refrigerador_id != idRefrigerador) {
                let elementoAtual = document.getElementById(`grafico${todosOsGraficos[i].Refrigerador_id}`)
                if (elementoAtual.classList.contains("display-block")) {
                    elementoAtual.classList.remove("display-block")
                    
                  }
              

                elementoAtual.classList.add("display-none")

                // alterando estilo do botão
                let btnAtual = document.getElementById(`btnRefrigerador${todosOsGraficos[i].Refrigerador_id}`)
                if (btnAtual.classList.contains("btn-pink")) {
                    btnAtual.classList.remove("btn-pink")
                }

                btnAtual.classList.add("btn-white")
            }
            if(todosOsGraficos[i].Refrigerador_id == idRefrigerador){

            titulo_refrigerador.innerHTML = `${todosOsGraficos[i].Local}`
            console.log(todosOsGraficos.Local);
            }  
        }

        // exibindo - ou não - o gráfico
        let graficoExibir = document.getElementById(`grafico${idRefrigerador}`)
        graficoExibir.classList.remove("display-none")
        graficoExibir.classList.add("display-block")

        let btnExibir = document.getElementById(`btnRefrigerador${idRefrigerador}`)
        btnExibir.classList.remove("btn-white")
        btnExibir.classList.add("btn-pink")
    }

function plotarGrafico(resposta, idAquario) {

console.log('iniciando plotagem do gráfico...');

// Criando estrutura para plotar gráfico - labels
let labels = [];

// Criando estrutura para plotar gráfico - dados
let dados = {
    labels: labels,
    datasets: [{
        label: 'Umidade',
        data: [],
        fill: false,
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
    },
    {
        label: 'Temperatura',
        data: [],
        fill: false,
        borderColor: 'rgb(199, 52, 52)',
        tension: 0.1
    }]
};

console.log('----------------------------------------------')
console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
console.log(resposta)

// Inserindo valores recebidos em estrutura para plotar o gráfico
for (i = 0; i < resposta.length; i++) {
    var registro = resposta[i];
    labels.push(registro.momento_grafico);
    dados.datasets[0].data.push(registro.umidade);
    dados.datasets[1].data.push(registro.temperatura);
}

console.log('----------------------------------------------')
console.log('O gráfico será plotado com os respectivos valores:')
console.log('Labels:')
console.log(labels)
console.log('Dados:')
console.log(dados.datasets)
console.log('----------------------------------------------')

// Criando estrutura para plotar gráfico - config
const config = {
    type: 'line',
    data: dados,
};

// Adicionando gráfico criado em div na tela
let myChart = new Chart(
    document.getElementById(`myChartCanvas${idAquario}`),
    config
);

setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
}
</script>